@using Microsoft.AspNetCore.Identity
@using MaiAmTinhThuong.Models
@model IEnumerable<BlogPost>
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Câu Chuyện - Mái Ấm Tình Thương";
}

<!-- Anti-forgery token for AJAX -->
@Html.AntiForgeryToken()

<div class="blog-container">
    <!-- Page Header -->
    <div class="text-center mb-4">
        <h1 class="blog-page-title">
            <i class="fas fa-book-open me-3"></i>Câu Chuyện
        </h1>
        <p class="blog-page-subtitle">Chia sẻ những khoảnh khắc đẹp và câu chuyện ý nghĩa</p>
    </div>

    <!-- Create Post Card -->
    <div class="blog-create-post">
        <div class="blog-card">
            <div class="blog-card-header">
                <div class="d-flex align-items-center">
                    @{
                        var currentUser = await UserManager.GetUserAsync(User);
                        var userAvatar = currentUser?.ProfilePicture ?? "/images/default1-avatar.png";
                    }
                    <img src="@userAvatar" alt="Avatar" class="blog-avatar" onerror="this.src='/images/default1-avatar.png'" />
                    <div class="ms-3">
                        <strong style="font-size: 1.1rem; color: #2c3e50;">@(currentUser?.FullName ?? currentUser?.Email ?? "Bạn")</strong>
                        <p class="mb-0 text-muted" style="font-size: 0.9rem;">Chia sẻ khoảnh khắc của bạn</p>
                    </div>
                </div>
            </div>
            <div class="blog-card-body">
                @if (TempData["PostPending"] != null)
                {
                    <div class="alert alert-info alert-dismissible fade show mb-3" role="alert" style="border-radius: 12px; border-left: 4px solid #17a2b8;">
                        <i class="fas fa-info-circle me-2"></i>@TempData["PostPending"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }
                <form method="post" enctype="multipart/form-data" action="@Url.Action("CreatePost", "Blog")" id="createPostForm">
                    <div class="mb-3">
                        <input type="text" class="form-control blog-input" name="Title" placeholder="✨ Tiêu đề bài viết..." required />
                    </div>
                    <div class="mb-3">
                        <textarea class="form-control blog-textarea" name="Content" rows="4" placeholder="💭 Bạn đang nghĩ gì thế? Hãy chia sẻ với mọi người..." required></textarea>
                    </div>
                    <div class="mb-3 d-flex align-items-center flex-wrap gap-2">
                        <label class="blog-file-label">
                            <i class="fas fa-image me-2"></i>Thêm ảnh
                            <input type="file" name="image" accept="image/*" class="d-none" id="imageInput" />
                        </label>
                        <span id="imageFileName" class="ms-2"></span>
                    </div>
                    <button type="submit" class="btn blog-btn-primary w-100">
                        <i class="fas fa-paper-plane me-2"></i>Đăng bài
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Content with Sidebar -->
    <div class="blog-main-content">
        <!-- Posts Feed -->
        <div class="blog-feed" id="blogFeed">
        @foreach (var post in Model)
        {
            <div class="blog-card blog-post-card" data-post-id="@post.Id">
                <!-- Post Header -->
                <div class="blog-card-header">
                    <div class="d-flex align-items-center">
                        <img src="@(post.Author?.ProfilePicture ?? "/images/default1-avatar.png")" 
                             alt="@(post.Author?.FullName ?? "User")" 
                             class="blog-avatar" 
                             onerror="this.src='/images/default1-avatar.png'" />
                        <div class="ms-3 flex-grow-1">
                            <strong style="font-size: 1.1rem; color: #2c3e50; display: block; margin-bottom: 0.25rem;">@(post.Author?.FullName ?? post.Author?.Email ?? "Unknown")</strong>
                            <p class="mb-0 text-muted" style="font-size: 0.85rem;">
                                <i class="far fa-clock me-1"></i>@post.CreatedAt.ToString("dd MMM yyyy 'lúc' HH:mm")
                            </p>
                        </div>
                        @if (post.AuthorId == ViewData["UserId"]?.ToString())
                        {
                            <div class="blog-post-actions">
                                <a href="@Url.Action("Edit", "Blog", new { id = post.Id })" class="blog-action-btn" title="Chỉnh sửa">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="@Url.Action("Delete", "Blog", new { id = post.Id })" class="blog-action-btn text-danger" title="Xóa" onclick="return confirm('Bạn có chắc muốn xóa bài viết này?');">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                            </div>
                        }
                    </div>
                </div>

                <!-- Post Image -->
                @if (!string.IsNullOrEmpty(post.ImageUrl))
                {
                    <div class="blog-post-image">
                        <img src="@post.ImageUrl" alt="@post.Title" class="img-fluid" />
                    </div>
                }

                <!-- Post Content -->
                <div class="blog-card-body">
                    <h5 class="blog-post-title">
                        <i class="fas fa-quote-left me-2" style="color: #667eea; font-size: 1.2rem;"></i>@post.Title
                    </h5>
                    <p class="blog-post-content">@post.Content</p>
                </div>

                <!-- Post Actions -->
                <div class="blog-card-footer">
                    <div class="blog-actions">
                        <button class="blog-like-btn @(post.LikedByUser ? "liked" : "")" data-post-id="@post.Id">
                            <i class="@(post.LikedByUser ? "fas" : "far") fa-heart"></i>
                        </button>
                        <button class="blog-comment-btn" data-post-id="@post.Id">
                            <i class="far fa-comment"></i>
                        </button>
                        <button class="blog-share-btn">
                            <i class="far fa-share-square"></i>
                        </button>
                    </div>
                    <div class="blog-likes-count">
                        <strong id="likeCount-@post.Id">@post.LikeCount</strong> lượt thích
                    </div>
                </div>

                <!-- Comments Section -->
                <div class="blog-comments-section" id="comments-@post.Id">
                    @if (post.Comments != null && post.Comments.Any())
                    {
                        @foreach (var comment in post.Comments.OrderByDescending(c => c.CreatedAt))
                        {
                            <div class="blog-comment-item">
                                <img src="@(comment.Author?.ProfilePicture ?? "/images/default1-avatar.png")" 
                                     alt="@(comment.Author?.FullName ?? "User")" 
                                     class="blog-comment-avatar" 
                                     onerror="this.src='/images/default1-avatar.png'" />
                                <div class="blog-comment-content">
                                    <strong>@(comment.Author?.FullName ?? comment.Author?.Email ?? "Unknown")</strong>
                                    <span>@comment.Content</span>
                                    <small class="text-muted">@comment.CreatedAt.ToString("dd MMM yyyy HH:mm")</small>
                                </div>
                            </div>
                        }
                    }
                </div>

                <!-- Add Comment Form -->
                <div class="blog-add-comment">
                    <form class="blog-comment-form" data-post-id="@post.Id">
                        <div class="d-flex align-items-center">
                            <img src="@userAvatar" alt="Avatar" class="blog-comment-avatar" onerror="this.src='/images/default1-avatar.png'" />
                            <input type="text" class="form-control blog-comment-input" placeholder="Thêm bình luận..." required />
                            <button type="submit" class="btn blog-comment-submit">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        }
        </div>

        <!-- Sidebar -->
        <div class="blog-sidebar">
            <div class="blog-card">
                <div class="blog-card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-fire me-2"></i>Xu Hướng
                    </h5>
                </div>
                <div class="blog-card-body">
                    <div class="blog-trending-item">
                        <i class="fas fa-hashtag text-primary me-2"></i>
                        <span>#MaiAmTinhThuong</span>
                    </div>
                    <div class="blog-trending-item">
                        <i class="fas fa-hashtag text-primary me-2"></i>
                        <span>#YeuThuong</span>
                    </div>
                    <div class="blog-trending-item">
                        <i class="fas fa-hashtag text-primary me-2"></i>
                        <span>#ChiaSe</span>
                    </div>
                </div>
            </div>

            <div class="blog-card mt-3">
                <div class="blog-card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Thông Tin
                    </h5>
                </div>
                <div class="blog-card-body">
                    <p class="small text-muted mb-2">
                        <i class="fas fa-lightbulb me-2"></i>Chia sẻ những câu chuyện, khoảnh khắc đẹp và lan tỏa yêu thương đến mọi người.
                    </p>
                    <p class="small text-muted mb-0">
                        <i class="fas fa-shield-alt me-2"></i>Nội dung sẽ được kiểm duyệt trước khi hiển thị.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Load More Button -->
    <div class="text-center mt-4">
        <button id="loadMoreBtn" class="btn blog-btn-secondary">
            <i class="fas fa-chevron-down me-2"></i>Tải thêm
        </button>
    </div>
</div>

<link rel="stylesheet" href="~/css/blog.css" asp-append-version="true" />
<script src="~/js/blog.js" asp-append-version="true"></script>
