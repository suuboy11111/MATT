@model MaiAmTinhThuong.Models.MaiAm
@using MaiAmTinhThuong.Models
@using System.Linq

<div class="container py-5" style="max-width: 1100px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #fafafa; border-radius: 12px; box-shadow: 0 6px 15px rgb(0 0 0 / 0.05); padding: 30px;">

    <h1 class="mb-3 fw-bold" style="color: #5a6d7c;">@Model.Name</h1>
    <p class="lead" style="color: #6c7b88;">@Model.Description</p>

    <div class="mb-4">
        <span class="badge rounded-pill" style="background-color: #d7e6f7; color: #4a6785; font-weight: 600; font-size: 1rem; padding: 0.5em 1em; margin-right: 1rem;">
            <i class="bi bi-geo-alt-fill me-1"></i> Địa chỉ: @Model.Address
        </span>
        <span class="badge rounded-pill" style="background-color: #d0f0e7; color: #3d7d65; font-weight: 600; font-size: 1rem; padding: 0.5em 1em;">
            <i class="bi bi-cash-stack me-1"></i> Quỹ tài trợ: @Model.Fund.ToString("N0") VNĐ
        </span>
    </div>

    <ul class="nav nav-tabs mb-4" id="maiAmTabs" role="tablist" style="border-bottom: 2px solid #cbd4db;">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-semibold" id="supportRequests-tab" data-bs-toggle="tab" data-bs-target="#supportRequests" type="button" role="tab" aria-controls="supportRequests" aria-selected="true" style="color: #54718a;">
                Người cần hỗ trợ <span class="badge rounded-pill" style="background-color: #f4cccc; color: #a85a5a;">@Model.SupportRequests.Count</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-semibold" id="supporters-tab" data-bs-toggle="tab" data-bs-target="#supporters" type="button" role="tab" aria-controls="supporters" aria-selected="false" style="color: #54718a;">
                Người hỗ trợ <span class="badge rounded-pill" style="background-color: #cde4dd; color: #3e6d55;">@Model.SupporterMaiAms.Count</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-semibold" id="statistics-tab" data-bs-toggle="tab" data-bs-target="#statistics" type="button" role="tab" aria-controls="statistics" aria-selected="false" style="color: #54718a;">
                Thống kê
            </button>
        </li>
    </ul>

    <div class="tab-content">

        <!-- Người cần hỗ trợ -->
        <div class="tab-pane fade show active" id="supportRequests" role="tabpanel" aria-labelledby="supportRequests-tab">
            <div class="table-responsive shadow-sm rounded-3 mb-4" style="box-shadow: 0 4px 10px rgba(150, 160, 170, 0.15);">
                <table class="table table-striped table-hover align-middle mb-0" style="color: #576971;">
                    <thead class="table-light" style="background-color: #e3ebf2;">
                        <tr>
                            <th>Tên</th>
                            <th>Tuổi</th>
                            <th>Hoàn cảnh</th>
                            <th>Tình trạng sức khỏe</th>
                            <th>Chi tiết</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var request in Model.SupportRequests ?? new List<SupportRequest>())
                        {
                            <tr>
                                <td>@(request.Name ?? "N/A")</td>
                                <td class="text-center">@request.Age</td>
                                <td>@{
                                    var reason = request.Reason ?? "";
                                    @(reason.Length > 40 ? reason.Substring(0, 40) + "..." : reason)
                                }</td>
                                <td>@{
                                    var healthStatus = request.HealthStatus ?? "";
                                    @(healthStatus.Length > 40 ? healthStatus.Substring(0, 40) + "..." : healthStatus)
                                }</td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm" style="background-color: #b8d8f7; color: #305e9e; border: none;" data-bs-toggle="modal" data-bs-target="#detailModal_@(request.Id)">
                                        Xem
                                    </button>
                                </td>
                            </tr>
                            
                            <!-- Modal Chi tiết Hồ sơ Cần Hỗ Trợ -->
                            <div class="modal fade" id="detailModal_@(request.Id)" tabindex="-1" aria-labelledby="detailModalLabel_@(request.Id)" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header" style="background-color: #b8d8f7;">
                                            <h5 class="modal-title" id="detailModalLabel_@(request.Id)">Chi tiết Hồ sơ: @(request.Name ?? "N/A")</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <strong>Họ và tên:</strong> @(request.Name ?? "N/A")
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Tuổi:</strong> @request.Age
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Giới tính:</strong> @(request.Gender ?? "N/A")
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <strong>Số điện thoại:</strong> @(request.PhoneNumber ?? "N/A")
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>Số CCCD:</strong> @(request.CCCD ?? "N/A")
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Địa chỉ:</strong> @(request.Address ?? "N/A")
                                            </div>
                                            <div class="mb-3">
                                                <strong>Hoàn cảnh:</strong>
                                                <p class="mt-2">@(request.Reason ?? "Chưa có thông tin")</p>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Tình trạng sức khỏe:</strong>
                                                <p class="mt-2">@(request.HealthStatus ?? "Chưa có thông tin")</p>
                                            </div>
                                            @if (!string.IsNullOrEmpty(request.ImageUrl))
                                            {
                                                <div class="mb-3">
                                                    <strong>Ảnh đại diện:</strong>
                                                    <img src="@request.ImageUrl" alt="Ảnh đại diện" class="img-fluid mt-2" style="max-height: 300px; border-radius: 8px;" />
                                                </div>
                                            }
                                            <div class="row mb-3">
                                                <div class="col-md-4">
                                                    <strong>Trạng thái:</strong>
                                                    <span class="badge @(request.IsApproved ? "bg-success" : "bg-warning")">
                                                        @(request.IsApproved ? "Đã duyệt" : "Chờ duyệt")
                                                    </span>
                                                </div>
                                                <div class="col-md-4">
                                                    <strong>Hỗ trợ hoàn cảnh:</strong>
                                                    <span class="badge @(request.IsSupportedReason ? "bg-success" : "bg-secondary")">
                                                        @(request.IsSupportedReason ? "Có" : "Chưa")
                                                    </span>
                                                </div>
                                                <div class="col-md-4">
                                                    <strong>Hỗ trợ sức khỏe:</strong>
                                                    <span class="badge @(request.IsSupportedHealth ? "bg-success" : "bg-secondary")">
                                                        @(request.IsSupportedHealth ? "Có" : "Chưa")
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Người hỗ trợ -->
        <div class="tab-pane fade" id="supporters" role="tabpanel" aria-labelledby="supporters-tab">
            <div class="table-responsive shadow-sm rounded-3 mb-4" style="box-shadow: 0 4px 10px rgba(150, 160, 170, 0.15);">
                <table class="table table-striped table-hover align-middle mb-0" style="color: #576971;">
                    <thead class="table-light" style="background-color: #e3ebf2;">
                        <tr>
                            <th>Tên</th>
                            <th>Tuổi</th>
                            <th>Loại hỗ trợ</th>
                            <th>Chi tiết</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var sma in Model.SupporterMaiAms ?? new List<SupporterMaiAm>())
                        {
                            var supporter = sma?.Supporter;
                            @if (supporter != null)
                            {
                                <tr>
                                    <td>@(supporter.Name ?? "N/A")</td>
                                    <td class="text-center">@supporter.Age</td>
                                    <td>@{
                                        var supportTypes = supporter.SupporterSupportTypes?
                                            .Where(sst => sst?.SupportType != null)
                                            .Select(sst => sst.SupportType.Name)
                                            .ToList() ?? new List<string>();
                                        @string.Join(", ", supportTypes)
                                    }</td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm" style="background-color: #c9e5db; color: #2a6041; border: none;" data-bs-toggle="modal" data-bs-target="#supporterDetailModal_@(supporter.Id)">
                                            Xem
                                        </button>
                                    </td>
                                </tr>
                                
                                <!-- Modal Chi tiết Người Hỗ Trợ -->
                                <div class="modal fade" id="supporterDetailModal_@(supporter.Id)" tabindex="-1" aria-labelledby="supporterDetailModalLabel_@(supporter.Id)" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header" style="background-color: #c9e5db;">
                                                <h5 class="modal-title" id="supporterDetailModalLabel_@(supporter.Id)">Chi tiết Người Hỗ Trợ: @(supporter.Name ?? "N/A")</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <strong>Họ và tên:</strong> @(supporter.Name ?? "N/A")
                                                    </div>
                                                    <div class="col-md-3">
                                                        <strong>Tuổi:</strong> @supporter.Age
                                                    </div>
                                                    <div class="col-md-3">
                                                        <strong>Giới tính:</strong> @(supporter.Gender ?? "N/A")
                                                    </div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <strong>Số điện thoại:</strong> @(supporter.PhoneNumber ?? "N/A")
                                                    </div>
                                                    <div class="col-md-6">
                                                        <strong>Số CCCD:</strong> @(supporter.CCCD ?? "N/A")
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <strong>Địa chỉ:</strong> @(supporter.Address ?? "N/A")
                                                </div>
                                                <div class="mb-3">
                                                    <strong>Loại hỗ trợ:</strong>
                                                    <ul class="mt-2">
                                                        @{
                                                            var types = supporter.SupporterSupportTypes?
                                                                .Where(sst => sst?.SupportType != null)
                                                                .Select(sst => sst.SupportType.Name)
                                                                .ToList() ?? new List<string>();
                                                        }
                                                        @foreach (var type in types)
                                                        {
                                                            <li>@type</li>
                                                        }
                                                        @if (!types.Any())
                                                        {
                                                            <li>Chưa có thông tin</li>
                                                        }
                                                    </ul>
                                                </div>
                                                @if (!string.IsNullOrEmpty(supporter.ImageUrl))
                                                {
                                                    <div class="mb-3">
                                                        <strong>Ảnh đại diện:</strong>
                                                        <img src="@supporter.ImageUrl" alt="Ảnh đại diện" class="img-fluid mt-2" style="max-height: 300px; border-radius: 8px;" />
                                                    </div>
                                                }
                                                <div class="mb-3">
                                                    <strong>Trạng thái:</strong>
                                                    <span class="badge @(supporter.IsApproved ? "bg-success" : "bg-warning")">
                                                        @(supporter.IsApproved ? "Đã duyệt" : "Chờ duyệt")
                                                    </span>
                                                </div>
                                                @if (supporter.MaiAm != null)
                                                {
                                                    <div class="mb-3">
                                                        <strong>Mái ấm hỗ trợ:</strong> @supporter.MaiAm.Name
                                                    </div>
                                                }
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Thống kê -->
        <div class="tab-pane fade" id="statistics" role="tabpanel" aria-labelledby="statistics-tab">
            <div class="card shadow-sm rounded-3 p-4 mb-4" style="background-color: #f5f9fc; border: none;">
                <canvas id="supportChart" style="max-height: 300px;"></canvas>
            </div>

            <div class="row text-center">
                <div class="col-md-4 mb-3">
                    <div class="p-3 rounded" style="background-color: #fce8e8; color: #a65b5b; box-shadow: 0 4px 10px rgb(172 106 106 / 0.15);">
                        <h5>@ViewBag.TotalSupportRequests</h5>
                        <p class="mb-0 fw-semibold">Người cần hỗ trợ</p>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="p-3 rounded" style="background-color: #d9f0e5; color: #2f6a4f; box-shadow: 0 4px 10px rgb(54 123 82 / 0.15);">
                        <h5>@ViewBag.TotalSupporters</h5>
                        <p class="mb-0 fw-semibold">Người hỗ trợ</p>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="p-3 rounded" style="background-color: #e6f1f8; color: #3a597a; box-shadow: 0 4px 10px rgb(51 93 129 / 0.15);">
                        <h5>@Model.Fund.ToString("N0") VNĐ</h5>
                        <p class="mb-0 fw-semibold">Quỹ tài trợ hiện tại</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        var ctx = document.getElementById('supportChart').getContext('2d');
        var supportChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Người cần hỗ trợ', 'Người hỗ trợ'],
                datasets: [{
                    label: 'Số lượng',
                    data: [@ViewBag.TotalSupportRequests, @ViewBag.TotalSupporters],
                    backgroundColor: ['#f4a9a9cc', '#8ac5a9cc'],
                    borderColor: ['#a65b5bcc', '#2f6a4fcc'],
                    borderWidth: 1
                }]
            },
            options: {
                scales: { y: { beginAtZero: true, precision: 0 } },
                plugins: { legend: { display: false } }
            }
        });
    </script>
}
